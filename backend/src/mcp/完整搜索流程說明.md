# å®Œæ•´å½±ç‰‡æœç´¢æµç¨‹èªªæ˜

## ğŸ“‹ ç›®éŒ„

1. [æ•´é«”æµç¨‹æ¦‚è¦½](#æ•´é«”æµç¨‹æ¦‚è¦½)
2. [å‰ç«¯æµç¨‹](#å‰ç«¯æµç¨‹)
3. [å¾Œç«¯æµç¨‹](#å¾Œç«¯æµç¨‹)
4. [å„æª”æ¡ˆèˆ‡å‡½æ•¸è©³ç´°èªªæ˜](#å„æª”æ¡ˆèˆ‡å‡½æ•¸è©³ç´°èªªæ˜)
5. [è³‡æ–™æµå‘åœ–](#è³‡æ–™æµå‘åœ–)

---

## æ•´é«”æµç¨‹æ¦‚è¦½

```
ç”¨æˆ¶è¼¸å…¥æŸ¥è©¢
    â†“
å‰ç«¯ API èª¿ç”¨
    â†“
å¾Œç«¯ç«¯é»è™•ç†
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 1: æŸ¥è©¢è§£æ                     â”‚
â”‚ - æ—¥æœŸè§£æï¼ˆMCPï¼‰                    â”‚
â”‚ - äº‹ä»¶é¡å‹è§£æ                       â”‚
â”‚ - é—œéµå­—æå–                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 2: PostgreSQL æŸ¥è©¢             â”‚
â”‚ - æ ¹æ“šæ—¥æœŸã€äº‹ä»¶ã€é—œéµå­—éæ¿¾         â”‚
â”‚ - è¿”å›ç¬¦åˆæ¢ä»¶çš„è¨˜éŒ„                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 3: é—œéµå­—æ“´å±•                   â”‚
â”‚ - æ“´å±•åŒç¾©è©ï¼ˆä¾‹å¦‚ï¼šç©æ°´â†’æ°´ç½ï¼‰      â”‚
â”‚ - ç”Ÿæˆå¤šå€‹æŸ¥è©¢è®Šé«”                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 4: å‘é‡æœç´¢ï¼ˆFAISSï¼‰            â”‚
â”‚ - å°æ¯å€‹æ“´å±•æŸ¥è©¢é€²è¡Œå‘é‡æœç´¢          â”‚
â”‚ - åˆä½µå»é‡                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 5: çµæœåˆä½µèˆ‡æ’åº                â”‚
â”‚ - åˆä½µ PostgreSQL å’Œå‘é‡æœç´¢çµæœ     â”‚
â”‚ - è¨ˆç®—æœ€çµ‚åˆ†æ•¸                       â”‚
â”‚ - æŒ‰åˆ†æ•¸æ’åº                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ æ­¥é©Ÿ 6: çµæœéæ¿¾èˆ‡æ ¼å¼åŒ–              â”‚
â”‚ - éæ¿¾ä½æ–¼é–€æª»çš„çµæœ                 â”‚
â”‚ - å– top_k                          â”‚
â”‚ - æ ¼å¼åŒ–è¿”å›çµ¦å‰ç«¯                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â†“
å‰ç«¯é¡¯ç¤ºçµæœ
```

---

## å‰ç«¯æµç¨‹

### æª”æ¡ˆï¼š`frontend/src/services/api.js`

#### å‡½æ•¸ 1ï¼š`searchRAG(query, topK, threshold, apiKey)`

**ä½ç½®ï¼š** ç¬¬ 121-148 è¡Œ

**åŠŸèƒ½ï¼š** ç™¼é€æœç´¢è«‹æ±‚åˆ°å¾Œç«¯ `/rag/search` ç«¯é»

**æµç¨‹ï¼š**
1. èª¿ç”¨ `this.request("/rag/search", {...})` ç™¼é€ POST è«‹æ±‚
2. è«‹æ±‚é«”åŒ…å«ï¼š
   - `query`: ç”¨æˆ¶æŸ¥è©¢æ–‡å­—
   - `top_k`: è¿”å›çµæœæ•¸é‡
   - `score_threshold`: åˆ†æ•¸é–€æª»
3. æ¥æ”¶å¾Œç«¯éŸ¿æ‡‰
4. å¦‚æœéŸ¿æ‡‰åŒ…å« `date_parsed`ï¼Œåœ¨ç€è¦½å™¨æ§åˆ¶å°è¼¸å‡ºæ—¥æœŸè§£æè³‡è¨Š
5. è¿”å›çµæœçµ¦èª¿ç”¨è€…

**é—œéµç¨‹å¼ç¢¼ï¼š**
```javascript
async searchRAG(query, topK, threshold, apiKey) {
  const data = await this.request("/rag/search", {
    method: "POST",
    body: {
      query,
      top_k: topK,
      score_threshold: threshold,
    },
    apiKey,
  });
  
  // è¼¸å‡ºæ—¥æœŸè§£æè³‡è¨Šåˆ°æ§åˆ¶å°
  if (data.date_parsed) {
    // ... æ ¼å¼åŒ–è¼¸å‡º ...
  }
  
  return data;
}
```

#### å‡½æ•¸ 2ï¼š`answerRAG(query, topK, threshold, apiKey)`

**ä½ç½®ï¼š** ç¬¬ 150-177 è¡Œ

**åŠŸèƒ½ï¼š** ç™¼é€å›ç­”è«‹æ±‚åˆ°å¾Œç«¯ `/rag/answer` ç«¯é»

**æµç¨‹ï¼š** èˆ‡ `searchRAG` é¡ä¼¼ï¼Œä½†èª¿ç”¨ `/rag/answer` ç«¯é»

---

## å¾Œç«¯æµç¨‹

### æª”æ¡ˆï¼š`backend/src/main.py`

### ç«¯é» 1ï¼š`/rag/search`

**ä½ç½®ï¼š** ç¬¬ 1526-1750 è¡Œ

**åŠŸèƒ½ï¼š** æœç´¢å½±ç‰‡ç‰‡æ®µï¼Œä½†ä¸è² è²¬è§£é‡‹å…§å®¹

**å®Œæ•´æµç¨‹ï¼š**

#### æ­¥é©Ÿ 1ï¼šæ¥æ”¶è«‹æ±‚ä¸¦è§£æåƒæ•¸

**å‡½æ•¸ï¼š** `rag_search(request: Request, db: Session)`

**è¡Œæ•¸ï¼š** 1527-1539

```python
payload = await request.json()
query = (payload.get("query") or "").strip()
top_k = int(payload.get("top_k") or 5)
score_threshold = float(payload.get("score_threshold") or 0.0)
```

#### æ­¥é©Ÿ 2ï¼šè§£ææŸ¥è©¢æ¢ä»¶

**å‡½æ•¸ï¼š** `_parse_query_filters(question: str)`

**ä½ç½®ï¼š** ç¬¬ 2578-2706 è¡Œ

**èª¿ç”¨ä½ç½®ï¼š** ç¬¬ 1548 è¡Œ

**åŠŸèƒ½ï¼š** å¾ç”¨æˆ¶æŸ¥è©¢ä¸­æå–éæ¿¾æ¢ä»¶

**å­æ­¥é©Ÿï¼š**

##### 2.1 æ—¥æœŸè§£æï¼ˆé€šé MCPï¼‰

**èª¿ç”¨éˆï¼š**
```
_parse_query_filters()
    â†“
parse_date_via_mcp()  # mcp_client.py
    â†“
MCPDateParserClient.parse_date()  # mcp_client.py
    â†“
MCP æœå‹™å™¨ (subprocess)  # mcp/server.py
    â†“
handle_tools_call("parse_date")  # mcp/server.py
    â†“
parse_query_time_window()  # mcp/tools/parse_time.py
```

**æª”æ¡ˆèˆ‡å‡½æ•¸ï¼š**

1. **`backend/src/main.py`** - `_parse_query_filters()` (ç¬¬ 2605-2630 è¡Œ)
   - èª¿ç”¨ `parse_date_via_mcp(question)`
   - è™•ç†è¿”å›çš„æ—¥æœŸçµæœï¼ˆå¯èƒ½æ˜¯å­—ä¸²æˆ– date å°è±¡ï¼‰
   - è¨­ç½® `filters["date_filter"]`, `filters["time_start"]`, `filters["time_end"]`, `filters["date_mode"]`

2. **`backend/src/mcp_client.py`** - `parse_date_via_mcp(query: str)` (ç¬¬ 162-173 è¡Œ)
   - ç²å–å…¨å±€ MCP å®¢æˆ¶ç«¯å¯¦ä¾‹
   - èª¿ç”¨ `client.parse_date(query)`

3. **`backend/src/mcp_client.py`** - `MCPDateParserClient.parse_date(query: str)` (ç¬¬ 108-139 è¡Œ)
   - ç™¼é€ JSON-RPC è«‹æ±‚åˆ° MCP æœå‹™å™¨
   - å¦‚æœå¤±æ•—ï¼Œå›é€€åˆ°ç›´æ¥èª¿ç”¨ `parse_query_time_window()`

4. **`backend/src/mcp/server.py`** - `handle_tools_call(tool_name: str, arguments: dict)` (ç¬¬ 96-110 è¡Œ)
   - æ¥æ”¶ JSON-RPC è«‹æ±‚
   - èª¿ç”¨ `parse_query_time_window(query)`
   - è¿”å› JSON-RPC éŸ¿æ‡‰

5. **`backend/src/mcp/tools/parse_time.py`** - `parse_query_time_window(query: str, now: Optional[datetime] = None, timezone: str = "Asia/Taipei")` (ç¬¬ 100-217 è¡Œ)
   - è§£æç›¸å°æ—¥æœŸï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æœ¬é€±ã€ä¸Šé€±ç­‰ï¼‰
   - è§£æ MMDD æ ¼å¼ï¼ˆ1225 â†’ 2025-12-25ï¼‰
   - è§£æ YYYYMMDD æ ¼å¼ï¼ˆ20251225ï¼‰
   - è¿”å›æ—¥æœŸç¯„åœå’Œæ¨¡å¼

**è¿”å›çµæœæ ¼å¼ï¼š**
```python
{
    "query": "çµ¦æˆ‘1225çš„å½±ç‰‡",
    "mode": "MMDD",  # æˆ– "RELATIVE_TODAY", "WEEK", "YYYYMMDD", "NONE"
    "picked_date": "2025-12-25",
    "time_start": "2025-12-25T00:00:00+08:00",
    "time_end": "2025-12-26T00:00:00+08:00",
    "date_filter": "2025-12-25"  # date å°è±¡
}
```

##### 2.2 äº‹ä»¶é¡å‹è§£æ

**ä½ç½®ï¼š** ç¬¬ 2632-2698 è¡Œ

**åŠŸèƒ½ï¼š** å¾æŸ¥è©¢ä¸­è­˜åˆ¥äº‹ä»¶é¡å‹é—œéµå­—

**æ˜ å°„è¡¨ï¼š**
```python
event_mapping = {
    "ç«ç½": "fire",
    "æ°´ç½": "water_flood",
    "å€’åœ°": "person_fallen_unmoving",
    "é—–å…¥": "security_door_tamper",
    # ... æ›´å¤šæ˜ å°„
}
```

**çµæœï¼š** è¨­ç½® `filters["event_types"]` åˆ—è¡¨

##### 2.3 é—œéµå­—æå–

**ä½ç½®ï¼š** ç¬¬ 2656-2691 è¡Œ

**åŠŸèƒ½ï¼š** æå– message é—œéµå­—ï¼ˆç”¨æ–¼å¾ŒçºŒçš„æ–‡æœ¬åŒ¹é…ï¼‰

**é—œéµå­—é¡å‹ï¼š**
- äº‹ä»¶é—œéµå­—ï¼šç«ç½ã€å€’åœ°ã€ç¾¤èšã€æ°´ç½ç­‰
- æè¿°æ€§é—œéµå­—ï¼šé¡è‰²+è¡£æœã€é¡è‰²+è»Šè¼›ç­‰

**çµæœï¼š** è¨­ç½® `filters["message_keywords"]` åˆ—è¡¨

##### 2.4 åœ°é»é—œéµå­—æå–

**ä½ç½®ï¼š** ç¬¬ 2700-2704 è¡Œ

**åŠŸèƒ½ï¼š** æå–åœ°é»é—œéµå­—ï¼ˆè·¯å£ã€å…¥å£ã€åœè»Šå ´ç­‰ï¼‰

**çµæœï¼š** è¨­ç½® `filters["location_keywords"]` åˆ—è¡¨

#### æ­¥é©Ÿ 3ï¼šPostgreSQL æŸ¥è©¢

**å‡½æ•¸ï¼š** `_filter_summaries_by_query(db: Session, filters: Dict[str, Any], limit: int = 1000)`

**ä½ç½®ï¼š** ç¬¬ 2744-2890 è¡Œ

**èª¿ç”¨ä½ç½®ï¼š** ç¬¬ 1578 è¡Œ

**åŠŸèƒ½ï¼š** æ ¹æ“šéæ¿¾æ¢ä»¶å¾ PostgreSQL æŸ¥è©¢ summaries

**SQL æŸ¥è©¢é‚è¼¯ï¼š**

1. **åŸºç¤æŸ¥è©¢** (ç¬¬ 2760-2770 è¡Œ)
   ```python
   query = db.query(
       Summary.start_timestamp,
       Summary.video,
       Summary.segment,
       Summary.time_range,
       Summary.event_reason,
       Summary.message
   ).filter(
       Summary.message.isnot(None),
       Summary.message != ""
   )
   ```

2. **æ—¥æœŸ/æ™‚é–“ç¯„åœéæ¿¾** (ç¬¬ 2772-2828 è¡Œ)
   - å„ªå…ˆä½¿ç”¨ `time_start` å’Œ `time_end`ï¼ˆæ”¯æ´é€±ç¯„åœç­‰ï¼‰
   - å¦‚æœæ²’æœ‰ï¼Œä½¿ç”¨ `date_filter`ï¼ˆå–®ä¸€æ—¥æœŸï¼‰
   - ä½¿ç”¨ `start_timestamp` æ¬„ä½é€²è¡Œç¯„åœéæ¿¾

3. **äº‹ä»¶é¡å‹éæ¿¾** (ç¬¬ 2830-2853 è¡Œ)
   - æ ¹æ“š `filters["event_types"]` éæ¿¾å°æ‡‰çš„ boolean æ¬„ä½
   - ä¾‹å¦‚ï¼š`fire == True`, `water_flood == True`

4. **é—œéµå­—éæ¿¾** (ç¬¬ 2855-2889 è¡Œ)
   - å¦‚æœ `filters["message_keywords"]` ä¸ç‚ºç©º
   - åœ¨ `message` å’Œ `event_reason` æ¬„ä½ä¸­æœç´¢é—œéµå­—
   - ä½¿ç”¨ SQL `ILIKE` é€²è¡Œæ¨¡ç³ŠåŒ¹é…

**è¿”å›æ ¼å¼ï¼š**
```python
{
    "video|segment|time_range": {
        "start_timestamp": datetime,
        "video": str,
        "segment": str,
        "time_range": str,
        "event_reason": str,
        "message": str
    },
    # ... æ›´å¤šè¨˜éŒ„
}
```

#### æ­¥é©Ÿ 4ï¼šé—œéµå­—æ“´å±•

**å‡½æ•¸ï¼š** `_expand_query_keywords(query: str) -> List[str]`

**ä½ç½®ï¼š** ç¬¬ 2709-2741 è¡Œ

**èª¿ç”¨ä½ç½®ï¼š** ç¬¬ 1588 è¡Œ

**åŠŸèƒ½ï¼š** å°æŸ¥è©¢åšé—œéµå­—æ“´å±•ï¼Œç”Ÿæˆå¤šå€‹æŸ¥è©¢è®Šé«”

**æ“´å±•æ˜ å°„ï¼š**
```python
keyword_expansions = {
    "ç©æ°´": ["ç©æ°´", "æ°´ç½", "æ·¹æ°´", "æ°´"],
    "ç«ç½": ["ç«ç½", "ç«", "ç…™", "æ¿ƒç…™"],
    "å€’åœ°": ["å€’åœ°", "å€’åœ°ä¸èµ·", "èºº", "è‡¥"],
    # ... æ›´å¤šæ˜ å°„
}
```

**ç¯„ä¾‹ï¼š**
- è¼¸å…¥ï¼š`"çµ¦æˆ‘ç©æ°´çš„å½±ç‰‡"`
- è¼¸å‡ºï¼š`["çµ¦æˆ‘ç©æ°´çš„å½±ç‰‡", "çµ¦æˆ‘æ°´ç½çš„å½±ç‰‡", "çµ¦æˆ‘æ·¹æ°´çš„å½±ç‰‡", "çµ¦æˆ‘æ°´çš„å½±ç‰‡"]`

#### æ­¥é©Ÿ 5ï¼šå‘é‡æœç´¢ï¼ˆFAISSï¼‰

**æª”æ¡ˆï¼š** `backend/src/rag_store.py`

**é¡åˆ¥ï¼š** `RAGStore`

**å‡½æ•¸ï¼š** `search(query: str, top_k: int = 5, filters: Optional[Dict[str, Any]] = None)`

**ä½ç½®ï¼š** ç¬¬ 162-218 è¡Œ

**èª¿ç”¨ä½ç½®ï¼š** ç¬¬ 1600 è¡Œï¼ˆåœ¨ `rag_search` ä¸­ï¼‰

**æµç¨‹ï¼š**

1. **åˆå§‹åŒ– RAGStore** (ç¬¬ 1592 è¡Œ)
   ```python
   store = RAGStore(store_dir=RAG_DIR)
   ```

2. **å°æ¯å€‹æ“´å±•æŸ¥è©¢é€²è¡Œæœç´¢** (ç¬¬ 1598-1617 è¡Œ)
   ```python
   for expanded_query in expanded_queries:
       vector_hits = store.search(expanded_query, top_k=vec_pool, filters={})
       # åˆä½µçµæœï¼ˆå»é‡ï¼‰
   ```

3. **å‘é‡æœç´¢å…§éƒ¨æµç¨‹** (`rag_store.py` ç¬¬ 162-218 è¡Œ)
   - å°‡æŸ¥è©¢æ–‡å­—è½‰æ›ç‚ºå‘é‡ï¼ˆembeddingï¼‰(ç¬¬ 170 è¡Œ)
   - åœ¨ FAISS ç´¢å¼•ä¸­æœç´¢ç›¸ä¼¼å‘é‡ (ç¬¬ 177 è¡Œ)
   - å¾ `meta.jsonl` è¼‰å…¥ metadata (ç¬¬ 181-182 è¡Œ)
   - æ‡‰ç”¨éæ¿¾å™¨ï¼ˆå¦‚æœæœ‰ï¼‰(ç¬¬ 184-200 è¡Œ)
   - è¿”å›çµæœåˆ—è¡¨

**è¿”å›æ ¼å¼ï¼š**
```python
[
    {
        "score": 0.85,  # ç›¸ä¼¼åº¦åˆ†æ•¸
        "metadata": {
            "video": "fire_1",
            "segment": "segment_0001.mp4",
            "time_range": "00:00:00 - 00:00:08",
            "summary": "...",
            "message": "..."
        }
    },
    # ... æ›´å¤šçµæœ
]
```

#### æ­¥é©Ÿ 6ï¼šçµæœåˆä½µèˆ‡æ’åº

**å‡½æ•¸ï¼š** `_merge_and_rank_results(vector_hits: List[Dict], sql_results: Dict, query_filters: Dict, message_keywords: List[str])`

**ä½ç½®ï¼š** ç¬¬ 2953-3064 è¡Œ

**èª¿ç”¨ä½ç½®ï¼š** ç¬¬ 1623 è¡Œ

**åŠŸèƒ½ï¼š** åˆä½µ PostgreSQL å’Œå‘é‡æœç´¢çš„çµæœï¼Œä¸¦è¨ˆç®—æœ€çµ‚åˆ†æ•¸

**åˆä½µé‚è¼¯ï¼š**

1. **è™•ç†å‘é‡æœç´¢çµæœ** (ç¬¬ 2974-3043 è¡Œ)
   - ç”Ÿæˆ `segment_uid`ï¼ˆæ ¼å¼ï¼š`"video|segment|time_range"`ï¼‰
   - è¨ˆç®— `vector_score`ï¼ˆå‘é‡ç›¸ä¼¼åº¦åˆ†æ•¸ï¼‰
   - å¦‚æœ `message_keywords` ä¸ç‚ºç©ºï¼Œæª¢æŸ¥é—œéµå­—åŒ¹é…ä¸¦åŠ åˆ†
   - æª¢æŸ¥æ˜¯å¦ä¹Ÿåœ¨ PostgreSQL çµæœä¸­
     - å¦‚æœå…©é‚Šéƒ½å‘½ä¸­ï¼šè¨ˆç®— SQL åˆ†æ•¸ä¸¦åŠ åˆ†ï¼ˆ`+0.15`ï¼‰
     - å¦‚æœåªåœ¨å‘é‡æœç´¢å‘½ä¸­ï¼š
       - å¦‚æœæœ‰æ—¥æœŸéæ¿¾ï¼š**éæ¿¾æ‰**ï¼ˆä¸ç¬¦åˆæ—¥æœŸæ¢ä»¶ï¼‰
       - å¦‚æœæ²’æœ‰æ—¥æœŸéæ¿¾ï¼šä¿ç•™

2. **è™•ç†åªåœ¨ PostgreSQL å‘½ä¸­çš„çµæœ** (ç¬¬ 3045-3059 è¡Œ)
   - è¨ˆç®— SQL åˆ†æ•¸
   - æ·»åŠ åˆ°åˆä½µçµæœä¸­ï¼ˆ`vector_score = 0.0`ï¼‰

3. **è¨ˆç®—æœ€çµ‚åˆ†æ•¸** (ç¬¬ 3023, 3032, 3050 è¡Œ)
   ```python
   # å…©é‚Šéƒ½å‘½ä¸­
   final_score = 0.65 * vector_score + 0.35 * sql_score + 0.15
   
   # åªåœ¨å‘é‡æœç´¢å‘½ä¸­ï¼ˆç„¡æ—¥æœŸéæ¿¾ï¼‰
   final_score = 0.65 * vector_score + 0.35 * 0.0
   
   # åªåœ¨ PostgreSQL å‘½ä¸­
   final_score = 0.65 * 0.0 + 0.35 * sql_score
   ```

4. **æŒ‰æœ€çµ‚åˆ†æ•¸æ’åº** (ç¬¬ 3061-3062 è¡Œ)

**SQL åˆ†æ•¸è¨ˆç®—ï¼š**

**å‡½æ•¸ï¼š** `_calculate_sql_score(sql_data: Dict, query_filters: Dict, message_keywords: List[str])`

**ä½ç½®ï¼š** ç¬¬ 2893-2950 è¡Œ

**è¨ˆåˆ†è¦å‰‡ï¼š**
- ç¬¦åˆæ™‚é–“ï¼š`+0.4`
- ç¬¦åˆäº‹ä»¶ booleanï¼š`+0.5`
- summary/message å‘½ä¸­é—œéµå­—ï¼š`+0.4`ï¼ˆç²¾ç¢ºåŒ¹é…ï¼‰æˆ– `+0.1`ï¼ˆéƒ¨åˆ†åŒ¹é…ï¼‰
- å¤šå€‹é—œéµå­—åŒ¹é…ï¼šé¡å¤– `+0.15`ï¼ˆæ¯å€‹é¡å¤–é—œéµå­—ï¼‰
- æ²’æœ‰åŒ¹é…åˆ°é—œéµå­—ä½†æœ‰é—œéµå­—è¦æ±‚ï¼š`-0.2`

#### æ­¥é©Ÿ 7ï¼šçµæœéæ¿¾èˆ‡æ ¼å¼åŒ–

**ä½ç½®ï¼š** ç¬¬ 1632-1750 è¡Œ

**æµç¨‹ï¼š**

1. **éæ¿¾ä½æ–¼é–€æª»çš„çµæœ** (ç¬¬ 1633-1636 è¡Œ)
   ```python
   filtered_results = [
       r for r in merged_results
       if r["final_score"] >= score_threshold
   ]
   ```

2. **å– top_k** (ç¬¬ 1639 è¡Œ)
   ```python
   final_results = filtered_results[:top_k]
   ```

3. **æ ¼å¼åŒ–çµæœ** (ç¬¬ 1642-1720 è¡Œ)
   - å„ªå…ˆä½¿ç”¨ `vector_hit` çš„ metadata
   - å¦‚æœ `video` æˆ– `segment` ç‚ºç©ºï¼Œå¾ `meta.jsonl` ä¸­æŸ¥æ‰¾
   - æ§‹å»ºè¿”å›æ ¼å¼

4. **è¿”å›éŸ¿æ‡‰** (ç¬¬ 1721-1750 è¡Œ)
   ```python
   response = {
       "backend": store.embed_model,
       "hits": norm_hits
   }
   if date_info:
       response["date_parsed"] = date_info
   return response
   ```

### ç«¯é» 2ï¼š`/rag/answer`

**ä½ç½®ï¼š** ç¬¬ 2081-2400 è¡Œ

**åŠŸèƒ½ï¼š** æœç´¢å½±ç‰‡ç‰‡æ®µä¸¦ä½¿ç”¨ LLM å›ç­”å•é¡Œ

**æµç¨‹ï¼š** èˆ‡ `/rag/search` é¡ä¼¼ï¼Œä½†åœ¨æœ€å¾Œæœƒï¼š
1. èª¿ç”¨ LLM ç”Ÿæˆå›ç­” (ç¬¬ 2200-2300 è¡Œ)
2. è¿”å›å›ç­”å’Œç›¸é—œç‰‡æ®µ

---

## å„æª”æ¡ˆèˆ‡å‡½æ•¸è©³ç´°èªªæ˜

### å‰ç«¯æª”æ¡ˆ

| æª”æ¡ˆ | å‡½æ•¸ | è¡Œæ•¸ | åŠŸèƒ½ |
|------|------|------|------|
| `frontend/src/services/api.js` | `searchRAG()` | 121-148 | ç™¼é€æœç´¢è«‹æ±‚ |
| `frontend/src/services/api.js` | `answerRAG()` | 150-177 | ç™¼é€å›ç­”è«‹æ±‚ |
| `frontend/src/services/api.js` | `request()` | 9-64 | é€šç”¨ HTTP è«‹æ±‚è™•ç† |

### å¾Œç«¯æª”æ¡ˆ

| æª”æ¡ˆ | å‡½æ•¸/é¡åˆ¥ | è¡Œæ•¸ | åŠŸèƒ½ |
|------|----------|------|------|
| `backend/src/main.py` | `rag_search()` | 1526-1750 | æœç´¢ç«¯é»ä¸»å‡½æ•¸ |
| `backend/src/main.py` | `rag_answer()` | 2081-2400 | å›ç­”ç«¯é»ä¸»å‡½æ•¸ |
| `backend/src/main.py` | `_parse_query_filters()` | 2578-2706 | è§£ææŸ¥è©¢æ¢ä»¶ |
| `backend/src/main.py` | `_expand_query_keywords()` | 2709-2741 | é—œéµå­—æ“´å±• |
| `backend/src/main.py` | `_filter_summaries_by_query()` | 2744-2890 | PostgreSQL æŸ¥è©¢ |
| `backend/src/main.py` | `_calculate_sql_score()` | 2893-2950 | SQL çµæœåˆ†æ•¸è¨ˆç®— |
| `backend/src/main.py` | `_merge_and_rank_results()` | 2953-3064 | çµæœåˆä½µèˆ‡æ’åº |
| `backend/src/rag_store.py` | `RAGStore.search()` | 162-218 | å‘é‡æœç´¢ |
| `backend/src/mcp_client.py` | `parse_date_via_mcp()` | 162-173 | MCP æ—¥æœŸè§£æï¼ˆä¾¿æ·å‡½æ•¸ï¼‰ |
| `backend/src/mcp_client.py` | `MCPDateParserClient.parse_date()` | 108-139 | MCP å®¢æˆ¶ç«¯æ—¥æœŸè§£æ |
| `backend/src/mcp/server.py` | `handle_tools_call()` | 96-110 | MCP æœå‹™å™¨å·¥å…·èª¿ç”¨è™•ç† |
| `backend/src/mcp/tools/parse_time.py` | `parse_query_time_window()` | 100-217 | æ—¥æœŸæ™‚é–“è§£ææ ¸å¿ƒé‚è¼¯ |

---

## è³‡æ–™æµå‘åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ï¼šfrontend/src/services/api.js                          â”‚
â”‚                                                              â”‚
â”‚  searchRAG(query, topK, threshold, apiKey)                  â”‚
â”‚    â†“                                                         â”‚
â”‚  POST /rag/search                                            â”‚
â”‚    { query, top_k, score_threshold }                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å¾Œç«¯ï¼šbackend/src/main.py                                    â”‚
â”‚                                                              â”‚
â”‚  rag_search(request, db)                                     â”‚
â”‚    â†“                                                         â”‚
â”‚  [æ­¥é©Ÿ 1] _parse_query_filters(query)                       â”‚
â”‚    â†“                                                         â”‚
â”‚    â”œâ”€â†’ parse_date_via_mcp()  # mcp_client.py                â”‚
â”‚    â”‚     â†“                                                   â”‚
â”‚    â”‚     MCPDateParserClient.parse_date()                   â”‚
â”‚    â”‚       â†“                                                 â”‚
â”‚    â”‚       subprocess â†’ mcp/server.py                       â”‚
â”‚    â”‚         â†“                                               â”‚
â”‚    â”‚         handle_tools_call("parse_date")                 â”‚
â”‚    â”‚           â†“                                             â”‚
â”‚    â”‚           parse_query_time_window()  # parse_time.py    â”‚
â”‚    â”‚                                                          â”‚
â”‚    â”œâ”€â†’ äº‹ä»¶é¡å‹è§£æ                                           â”‚
â”‚    â””â”€â†’ é—œéµå­—æå–                                             â”‚
â”‚    â†“                                                         â”‚
â”‚  [æ­¥é©Ÿ 2] _filter_summaries_by_query(db, filters)           â”‚
â”‚    â†“                                                         â”‚
â”‚    PostgreSQL æŸ¥è©¢ï¼ˆæ—¥æœŸã€äº‹ä»¶ã€é—œéµå­—éæ¿¾ï¼‰                  â”‚
â”‚    â†“                                                         â”‚
â”‚  [æ­¥é©Ÿ 3] _expand_query_keywords(query)                     â”‚
â”‚    â†“                                                         â”‚
â”‚    ç”Ÿæˆå¤šå€‹æŸ¥è©¢è®Šé«”                                           â”‚
â”‚    â†“                                                         â”‚
â”‚  [æ­¥é©Ÿ 4] RAGStore.search()  # rag_store.py                â”‚
â”‚    â†“                                                         â”‚
â”‚    å°æ¯å€‹æ“´å±•æŸ¥è©¢é€²è¡Œå‘é‡æœç´¢                                 â”‚
â”‚    â†“                                                         â”‚
â”‚  [æ­¥é©Ÿ 5] _merge_and_rank_results()                        â”‚
â”‚    â†“                                                         â”‚
â”‚    â”œâ”€â†’ _calculate_sql_score()                               â”‚
â”‚    â””â”€â†’ åˆä½µä¸¦æ’åºçµæœ                                         â”‚
â”‚    â†“                                                         â”‚
â”‚  [æ­¥é©Ÿ 6] éæ¿¾ã€å– top_kã€æ ¼å¼åŒ–                             â”‚
â”‚    â†“                                                         â”‚
â”‚  è¿”å› { hits, date_parsed }                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                          â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ å‰ç«¯ï¼šæ¥æ”¶éŸ¿æ‡‰ä¸¦é¡¯ç¤ºçµæœ                                       â”‚
â”‚                                                              â”‚
â”‚  - é¡¯ç¤ºæœç´¢çµæœ                                               â”‚
â”‚  - åœ¨æ§åˆ¶å°è¼¸å‡ºæ—¥æœŸè§£æè³‡è¨Š                                     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

---

## é—œéµè³‡æ–™çµæ§‹

### æŸ¥è©¢éæ¿¾å™¨ (`query_filters`)

```python
{
    "date_filter": date("2025-12-25"),  # æˆ– None
    "time_start": "2025-12-25T00:00:00+08:00",  # æˆ– None
    "time_end": "2025-12-26T00:00:00+08:00",  # æˆ– None
    "date_mode": "MMDD",  # æˆ– "RELATIVE_TODAY", "WEEK", "YYYYMMDD", "NONE"
    "location_keywords": ["è·¯å£", "å…¥å£"],
    "event_types": ["fire", "water_flood"],
    "message_keywords": ["ç«ç½", "é»ƒè‰²è¡£æœ"]
}
```

### PostgreSQL æŸ¥è©¢çµæœ (`sql_results`)

```python
{
    "fire_1|segment_0001.mp4|00:00:00 - 00:00:08": {
        "start_timestamp": datetime(2025, 12, 25, 0, 0, 0),
        "video": "fire_1",
        "segment": "segment_0001.mp4",
        "time_range": "00:00:00 - 00:00:08",
        "event_reason": "ç«ç½",
        "message": "æª¢æ¸¬åˆ°ç«ç½..."
    },
    # ... æ›´å¤šè¨˜éŒ„
}
```

### å‘é‡æœç´¢çµæœ (`vector_hits`)

```python
[
    {
        "score": 0.85,
        "metadata": {
            "video": "fire_1",
            "segment": "segment_0001.mp4",
            "time_range": "00:00:00 - 00:00:08",
            "summary": "...",
            "message": "..."
        }
    },
    # ... æ›´å¤šçµæœ
]
```

### åˆä½µçµæœ (`merged_results`)

```python
[
    {
        "segment_uid": "fire_1|segment_0001.mp4|00:00:00 - 00:00:08",
        "vector_score": 0.85,
        "sql_score": 0.9,
        "final_score": 0.92,  # 0.65 * 0.85 + 0.35 * 0.9 + 0.15
        "in_both": True,
        "vector_hit": {...},
        "sql_data": {...}
    },
    # ... æ›´å¤šçµæœï¼ˆå·²æ’åºï¼‰
]
```

---

## ç¸½çµ

å®Œæ•´çš„å½±ç‰‡æœç´¢æµç¨‹æ¶‰åŠï¼š

1. **å‰ç«¯**ï¼šç™¼é€ HTTP è«‹æ±‚
2. **å¾Œç«¯ç«¯é»**ï¼šæ¥æ”¶ä¸¦è™•ç†è«‹æ±‚
3. **æŸ¥è©¢è§£æ**ï¼šé€šé MCP è§£ææ—¥æœŸã€äº‹ä»¶ã€é—œéµå­—
4. **PostgreSQL æŸ¥è©¢**ï¼šæ ¹æ“šéæ¿¾æ¢ä»¶æŸ¥è©¢è³‡æ–™åº«
5. **é—œéµå­—æ“´å±•**ï¼šç”Ÿæˆå¤šå€‹æŸ¥è©¢è®Šé«”
6. **å‘é‡æœç´¢**ï¼šä½¿ç”¨ FAISS é€²è¡Œèªç¾©æœç´¢
7. **çµæœåˆä½µ**ï¼šåˆä½µä¸¦æ’åºå…©ç¨®æœç´¢çµæœ
8. **æ ¼å¼åŒ–è¿”å›**ï¼šæ ¼å¼åŒ–çµæœä¸¦è¿”å›çµ¦å‰ç«¯

æ•´å€‹ç³»çµ±æ¡ç”¨**æ··åˆæœç´¢ï¼ˆHybrid Searchï¼‰**ç­–ç•¥ï¼Œçµåˆäº†ï¼š
- **PostgreSQL**ï¼šç²¾ç¢ºçš„çµæ§‹åŒ–æŸ¥è©¢ï¼ˆæ—¥æœŸã€äº‹ä»¶é¡å‹ï¼‰
- **FAISS å‘é‡æœç´¢**ï¼šèªç¾©ç›¸ä¼¼åº¦æœç´¢
- **æ™ºèƒ½åˆä½µ**ï¼šæ ¹æ“šå…©ç¨®æœç´¢çµæœè¨ˆç®—æœ€çµ‚åˆ†æ•¸ä¸¦æ’åº

