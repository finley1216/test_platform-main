# æ—¥æœŸè§£ææµç¨‹èªªæ˜

## ğŸ“‹ ç›®éŒ„
1. [æ•´é«”æµç¨‹](#æ•´é«”æµç¨‹)
2. [æŠ€è¡“å¯¦ç¾](#æŠ€è¡“å¯¦ç¾)
3. [å•é¡Œè§£ç­”](#å•é¡Œè§£ç­”)

---

## ğŸ”„ æ•´é«”æµç¨‹

### èª¿ç”¨éˆ

```
ç”¨æˆ¶æŸ¥è©¢ "çµ¦æˆ‘ä»Šå¤©çš„å½±ç‰‡"
    â†“
main.py::_parse_query_filters()
    â†“
mcp_client.py::parse_date_via_mcp()
    â†“
mcp/tools/parse_time.py::parse_query_time_window()
    â†“
è§£æçµæœè¿”å›
```

### è©³ç´°æ­¥é©Ÿ

#### 1. **å…¥å£ï¼š`main.py::_parse_query_filters()`**
```python
# èª¿ç”¨ MCP å®¢æˆ¶ç«¯
date_result = parse_date_via_mcp(question)
```

#### 2. **MCP å®¢æˆ¶ç«¯ï¼š`mcp_client.py`**
```python
# é€šé JSON-RPC èª¿ç”¨ MCP æœå‹™å™¨
result = client.parse_date(query)
# å¦‚æœ MCP å¤±æ•—ï¼Œå›é€€åˆ°ç›´æ¥èª¿ç”¨
parse_query_time_window(query)
```

#### 3. **æ ¸å¿ƒè§£æï¼š`mcp/tools/parse_time.py::parse_query_time_window()`**

**è§£æå„ªå…ˆé †åºï¼š**

```
1. ç›¸å°æ—¥æœŸè©ï¼ˆä»Šå¤©/æ˜¨å¤©/æœ¬é€±ç­‰ï¼‰
   â†“ å¦‚æœæ²’æœ‰åŒ¹é…
2. YYYYMMDD æ ¼å¼ï¼ˆ20251225ï¼‰
   â†“ å¦‚æœæ²’æœ‰åŒ¹é…
3. MMDD æ ¼å¼ï¼ˆ1225 / 12/25ï¼‰
   â†“ å¦‚æœæ²’æœ‰åŒ¹é…
4. date-extractorï¼ˆè‡ªç„¶èªè¨€ï¼Œå¯é¸ï¼‰
```

---

## ğŸ› ï¸ æŠ€è¡“å¯¦ç¾

### 1. **ç›¸å°æ—¥æœŸè§£æ**

**å‡½æ•¸ï¼š`parse_relative_date(text: str, now: datetime)`**

ä½¿ç”¨**é—œéµå­—åŒ¹é…**æŠ€è¡“ï¼š

```python
# æª¢æŸ¥æ–‡å­—ä¸­æ˜¯å¦åŒ…å«ç‰¹å®šé—œéµå­—
if "ä»Šå¤©" in text or "ä»Šæ—¥" in text:
    # è¨ˆç®—ä»Šå¤©çš„æ—¥æœŸç¯„åœ
    today = now.date()
    start, end = day_window(today)  # 00:00:00 ~ æ¬¡æ—¥ 00:00:00
    return {"mode": "RELATIVE_TODAY", "picked": today, ...}
```

**æ”¯æ´çš„é—œéµå­—ï¼š**
- ä»Šå¤©/ä»Šæ—¥ â†’ `RELATIVE_TODAY`
- æ˜¨å¤© â†’ `RELATIVE_YESTERDAY`
- å‰å¤© â†’ `RELATIVE_DAY_BEFORE_YESTERDAY`
- æ˜å¤© â†’ `RELATIVE_TOMORROW`
- æœ¬é€±/é€™é€± â†’ `RELATIVE_THIS_WEEK`
- ä¸Šé€±/ä¸Šå‘¨ â†’ `RELATIVE_LAST_WEEK`
- ä¸‹é€±/ä¸‹å‘¨ â†’ `RELATIVE_NEXT_WEEK`

### 2. **MMDD æ ¼å¼è§£æ**

**å‡½æ•¸ï¼š`parse_mmdd_from_text(text: str)`**

ä½¿ç”¨**æ­£å‰‡è¡¨é”å¼ï¼ˆRegexï¼‰**æŠ€è¡“ï¼š

```python
# åŒ¹é… MM/DD æˆ– MM-DD æ ¼å¼
m = re.search(r"(?<!\d)(\d{1,2})[/-](\d{1,2})(?!\d)", text)
# ä¾‹å¦‚ï¼š12/25, 12-25

# åŒ¹é… 4 ä½æ•¸å­— MMDD æ ¼å¼
m = re.search(r"(?<!\d)(\d{4})(?!\d)", text)
# ä¾‹å¦‚ï¼š1225
```

**æ­£å‰‡è¡¨é”å¼èªªæ˜ï¼š**
- `(?<!\d)` - è² å‘å›é¡§æ–·è¨€ï¼šç¢ºä¿å‰é¢ä¸æ˜¯æ•¸å­—
- `(\d{1,2})` - æ•ç² 1-2 ä½æ•¸å­—ï¼ˆæœˆä»½ï¼‰
- `[/-]` - åŒ¹é… `/` æˆ– `-`
- `(\d{1,2})` - æ•ç² 1-2 ä½æ•¸å­—ï¼ˆæ—¥æœŸï¼‰
- `(?!\d)` - è² å‘å‰ç»æ–·è¨€ï¼šç¢ºä¿å¾Œé¢ä¸æ˜¯æ•¸å­—

### 3. **YYYYMMDD æ ¼å¼è§£æ**

**å‡½æ•¸ï¼š`parse_yyyymmdd_from_text(text: str)`**

ä½¿ç”¨**æ­£å‰‡è¡¨é”å¼ + æ—¥æœŸé©—è­‰**ï¼š

```python
# åŒ¹é… 8 ä½æ•¸å­— YYYYMMDD
m = re.search(r"(?<!\d)(\d{4})(\d{2})(\d{2})(?!\d)", text)
# ä¾‹å¦‚ï¼š20251225

# é©—è­‰æ—¥æœŸæœ‰æ•ˆæ€§
if 2000 <= year <= 2100 and 1 <= month <= 12 and 1 <= day <= 31:
    date(year, month, day)  # æª¢æŸ¥æ˜¯å¦ç‚ºæœ‰æ•ˆæ—¥æœŸï¼ˆä¾‹å¦‚ 2/30 æœƒå¤±æ•—ï¼‰
```

### 4. **é€±ç¯„åœè¨ˆç®—**

**å‡½æ•¸ï¼š`week_window(anchor: date)`**

```python
# è¨ˆç®—åŒ…å« anchor æ—¥æœŸçš„é€±ä¸€
monday = anchor - timedelta(days=anchor.weekday())
# é€±ç¯„åœï¼šé€±ä¸€ 00:00:00 ~ ä¸‹é€±ä¸€ 00:00:00
start = datetime.combine(monday, time(0, 0, 0), tzinfo=TZ)
end = start + timedelta(days=7)
```

---

## â“ å•é¡Œè§£ç­”

### 1. **ä»Šå¤©ï¼Œé€™å€‹æ™‚é–“æ˜¯æ€éº¼æŠ“åˆ°ï¼Ÿ**

**ç­”æ¡ˆï¼š** ä½¿ç”¨ Python çš„ `datetime.now()` ç²å–ç•¶å‰æ™‚é–“

**å¯¦ç¾ä½ç½®ï¼š** `mcp/tools/parse_time.py::parse_query_time_window()`

```python
if now is None:
    tz = ZoneInfo(timezone)  # é»˜èª "Asia/Taipei"
    now = datetime.now(tz)   # ç²å–ç•¶å‰æ™‚é–“ï¼ˆå¸¶æ™‚å€ï¼‰

# ç•¶åŒ¹é…åˆ° "ä»Šå¤©" æ™‚
today = now.date()  # æå–æ—¥æœŸéƒ¨åˆ†ï¼ˆä¾‹å¦‚ï¼š2025-12-29ï¼‰
start, end = day_window(today)  # è¨ˆç®—ç•¶å¤©çš„æ™‚é–“ç¯„åœ
```

**æµç¨‹ï¼š**
1. èª¿ç”¨ `datetime.now(ZoneInfo("Asia/Taipei"))` ç²å–ç•¶å‰æ™‚é–“
2. ä½¿ç”¨ `.date()` æå–æ—¥æœŸéƒ¨åˆ†
3. è¨ˆç®—ç•¶å¤©çš„æ™‚é–“ç¯„åœï¼ˆ00:00:00 ~ æ¬¡æ—¥ 00:00:00ï¼‰

---

### 2. **æ˜¯ä½¿ç”¨ä»€éº¼æŠ€è¡“ä¾†ç²¾æº–å–å¾—å¥å­ä¸­çš„æ™‚é–“ï¼Ÿ**

**ç­”æ¡ˆï¼š** ä½¿ç”¨**æ­£å‰‡è¡¨é”å¼ï¼ˆRegular Expressionï¼‰**å’Œ**é—œéµå­—åŒ¹é…**

**æŠ€è¡“ç´°ç¯€ï¼š**

#### **æ–¹æ³• 1ï¼šé—œéµå­—åŒ¹é…ï¼ˆç›¸å°æ—¥æœŸï¼‰**
```python
# ç°¡å–®çš„å­—ä¸²åŒ…å«æª¢æŸ¥
if "ä»Šå¤©" in text or "ä»Šæ—¥" in text:
    # åŒ¹é…æˆåŠŸ
```
- **å„ªé»ï¼š** å¿«é€Ÿã€æº–ç¢º
- **é©ç”¨ï¼š** ç›¸å°æ—¥æœŸè©ï¼ˆä»Šå¤©ã€æ˜¨å¤©ã€æœ¬é€±ç­‰ï¼‰

#### **æ–¹æ³• 2ï¼šæ­£å‰‡è¡¨é”å¼ï¼ˆæ•¸å­—æ ¼å¼ï¼‰**
```python
# MMDD æ ¼å¼
re.search(r"(?<!\d)(\d{4})(?!\d)", text)  # åŒ¹é… 1225

# YYYYMMDD æ ¼å¼
re.search(r"(?<!\d)(\d{4})(\d{2})(\d{2})(?!\d)", text)  # åŒ¹é… 20251225

# MM/DD æˆ– MM-DD æ ¼å¼
re.search(r"(?<!\d)(\d{1,2})[/-](\d{1,2})(?!\d)", text)  # åŒ¹é… 12/25 æˆ– 12-25
```
- **å„ªé»ï¼š** ç²¾ç¢ºåŒ¹é…æ•¸å­—æ ¼å¼
- **é©ç”¨ï¼š** MMDDã€YYYYMMDDã€MM/DD ç­‰æ ¼å¼

#### **æ–¹æ³• 3ï¼šdate-extractorï¼ˆå¯é¸ï¼Œæœªå•Ÿç”¨ï¼‰**
```python
# ä½¿ç”¨ç¬¬ä¸‰æ–¹åº«è§£æè‡ªç„¶èªè¨€æ—¥æœŸ
from date_extractor import extract_dates
dates = extract_dates(query)
```
- **å„ªé»ï¼š** æ”¯æ´è¤‡é›œçš„è‡ªç„¶èªè¨€
- **ç¼ºé»ï¼š** éœ€è¦é¡å¤–ä¾è³´ï¼Œç›®å‰æœªå•Ÿç”¨

---

### 3. **æ€éº¼è¨­å®šä¸Šé€±å’Œé€™é€±é€™é¡çš„è¨­å®šï¼Ÿ**

**ç­”æ¡ˆï¼š** é€šé `week_window()` å‡½æ•¸è¨ˆç®—é€±ç¯„åœ

**å¯¦ç¾ä½ç½®ï¼š** `mcp/tools/parse_time.py::week_window()`

```python
def week_window(anchor: date) -> Tuple[datetime, datetime]:
    """Return Monday 00:00 ~ next Monday 00:00 for the week containing anchor."""
    # è¨ˆç®—åŒ…å« anchor æ—¥æœŸçš„é€±ä¸€
    monday = anchor - timedelta(days=anchor.weekday())
    
    # é€±ä¸€é–‹å§‹æ™‚é–“
    start = datetime.combine(monday, time(0, 0, 0), tzinfo=TZ)
    
    # ä¸‹é€±ä¸€é–‹å§‹æ™‚é–“ï¼ˆçµæŸæ™‚é–“ï¼‰
    end = start + timedelta(days=7)
    
    return start, end
```

**ä½¿ç”¨ç¯„ä¾‹ï¼š**

```python
# æœ¬é€±
if "æœ¬é€±" in text:
    today = now.date()
    start, end = week_window(today)  # æœ¬é€±ä¸€åˆ°ä¸‹é€±ä¸€

# ä¸Šé€±
if "ä¸Šé€±" in text:
    last_week_date = today - timedelta(days=7)
    start, end = week_window(last_week_date)  # ä¸Šé€±ä¸€åˆ°æœ¬é€±ä¸€

# ä¸‹é€±
if "ä¸‹é€±" in text:
    next_week_date = today + timedelta(days=7)
    start, end = week_window(next_week_date)  # ä¸‹é€±ä¸€åˆ°ä¸‹ä¸‹é€±ä¸€
```

**é€±çš„å®šç¾©ï¼š**
- **é–‹å§‹ï¼š** é€±ä¸€ 00:00:00
- **çµæŸï¼š** ä¸‹é€±ä¸€ 00:00:00ï¼ˆä¸åŒ…å«ï¼‰
- **ç¯„åœï¼š** 7 å¤©ï¼ˆé€±ä¸€åˆ°é€±æ—¥ï¼‰

---

### 4. **æ‰€ä»¥åªè¼¸å…¥æœˆå’Œæ—¥å°±æœƒè‡ªå‹•å°æ‡‰åˆ°ç›®å‰çš„å¹´ä»½ï¼Œå°±ç®—ä½¿ç”¨è€…æ²’è¼¸å…¥ä¹Ÿæ˜¯ç›´æ¥å°æ‡‰åˆ°ï¼Ÿ**

**ç­”æ¡ˆï¼š** æ˜¯çš„ï¼Œå®Œå…¨æ­£ç¢ºï¼

**å¯¦ç¾ä½ç½®ï¼š** `mcp/tools/parse_time.py::parse_query_time_window()`

```python
# 3) MMDD shorthand (1220 / 12/20)
mmdd = parse_mmdd_from_text(query)
if mmdd:
    mm, dd = mmdd
    d = date(now.year, mm, dd)  # â† ä½¿ç”¨ç•¶å‰å¹´ä»½
    start, end = day_window(d)
    return {
        "mode": "MMDD_RULE",
        "picked_date": d.isoformat(),  # ä¾‹å¦‚ï¼š2025-12-25
        ...
    }
```

**ç¯„ä¾‹ï¼š**

| ç”¨æˆ¶è¼¸å…¥ | è§£æçµæœ | èªªæ˜ |
|---------|---------|------|
| `çµ¦æˆ‘1225çš„å½±ç‰‡` | `2025-12-25` | ä½¿ç”¨ç•¶å‰å¹´ä»½ 2025 |
| `çµ¦æˆ‘12/25çš„å½±ç‰‡` | `2025-12-25` | ä½¿ç”¨ç•¶å‰å¹´ä»½ 2025 |
| `çµ¦æˆ‘12-25çš„å½±ç‰‡` | `2025-12-25` | ä½¿ç”¨ç•¶å‰å¹´ä»½ 2025 |
| `çµ¦æˆ‘20251225çš„å½±ç‰‡` | `2025-12-25` | ä½¿ç”¨ç”¨æˆ¶æŒ‡å®šçš„å¹´ä»½ |

**é‚è¼¯ï¼š**
1. å¦‚æœç”¨æˆ¶è¼¸å…¥ 4 ä½æ•¸å­—ï¼ˆMMDDï¼‰æˆ– MM/DD æ ¼å¼
2. ç³»çµ±æœƒ**è‡ªå‹•ä½¿ç”¨ç•¶å‰å¹´ä»½**ï¼ˆ`datetime.now().year`ï¼‰
3. å¦‚æœç”¨æˆ¶è¼¸å…¥ 8 ä½æ•¸å­—ï¼ˆYYYYMMDDï¼‰ï¼Œå‰‡ä½¿ç”¨ç”¨æˆ¶æŒ‡å®šçš„å¹´ä»½

**æ³¨æ„ï¼š**
- å¦‚æœç•¶å‰æ˜¯ 2025 å¹´ï¼Œè¼¸å…¥ `1225` æœƒè§£æç‚º `2025-12-25`
- å¦‚æœç•¶å‰æ˜¯ 2026 å¹´ï¼Œè¼¸å…¥ `1225` æœƒè§£æç‚º `2026-12-25`
- å¦‚æœéœ€è¦æŒ‡å®šå¹´ä»½ï¼Œå¿…é ˆä½¿ç”¨ `20251225` æ ¼å¼

---

## ğŸ“Š è§£æå„ªå…ˆé †åºç¸½çµ

```
1. ç›¸å°æ—¥æœŸè©ï¼ˆæœ€å¿«ï¼‰
   â”œâ”€ ä»Šå¤© â†’ 2025-12-29
   â”œâ”€ æ˜¨å¤© â†’ 2025-12-28
   â”œâ”€ æœ¬é€± â†’ 2025-12-29 ~ 2026-01-05
   â””â”€ ä¸Šé€± â†’ 2025-12-22 ~ 2025-12-29

2. YYYYMMDD æ ¼å¼
   â””â”€ 20251225 â†’ 2025-12-25ï¼ˆä½¿ç”¨æŒ‡å®šå¹´ä»½ï¼‰

3. MMDD æ ¼å¼ï¼ˆè‡ªå‹•ä½¿ç”¨ç•¶å‰å¹´ä»½ï¼‰
   â”œâ”€ 1225 â†’ 2025-12-25
   â”œâ”€ 12/25 â†’ 2025-12-25
   â””â”€ 12-25 â†’ 2025-12-25

4. date-extractorï¼ˆå¯é¸ï¼Œæœªå•Ÿç”¨ï¼‰
   â””â”€ è‡ªç„¶èªè¨€æ—¥æœŸè§£æ
```

---

## ğŸ”§ é…ç½®æª”æ¡ˆ

**ä½ç½®ï¼š** `mcp/config.yaml`

```yaml
# æ™‚å€è¨­å®š
timezone: "Asia/Taipei"

# é è¨­å¹´ä»½ç­–ç•¥
default_year_strategy: "current"  # ä½¿ç”¨ç•¶å‰å¹´ä»½
```

---

## ğŸ“ ç›¸é—œæª”æ¡ˆ

- **æ ¸å¿ƒé‚è¼¯ï¼š** `mcp/tools/parse_time.py`
- **MCP æœå‹™å™¨ï¼š** `mcp/server.py`
- **MCP å®¢æˆ¶ç«¯ï¼š** `mcp_client.py`
- **é…ç½®æª”æ¡ˆï¼š** `mcp/config.yaml`
- **èª¿ç”¨å…¥å£ï¼š** `main.py::_parse_query_filters()`

