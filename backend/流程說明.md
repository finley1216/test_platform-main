# å½±ç‰‡åˆ†æå®Œæ•´æµç¨‹èªªæ˜

## ä¸»è¦ APIï¼š`/v1/segment_pipeline_multipart`

### æ•´é«”æµç¨‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  1. æ¥æ”¶è«‹æ±‚ (segment_pipeline_multipart)                      â”‚
â”‚     - file / video_url / video_id                               â”‚
â”‚     - model_type (qwen/gemini/owl/yolo)                        â”‚
â”‚     - segment_duration, overlap, ç­‰åƒæ•¸                         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  2. ä¸‹è¼‰/ç²å–å½±ç‰‡                                                â”‚
â”‚     â”œâ”€ file: ä¸Šå‚³æª”æ¡ˆ â†’ è‡¨æ™‚æª”æ¡ˆ                                â”‚
â”‚     â”œâ”€ video_url: ä¸‹è¼‰åˆ°è‡¨æ™‚æª”æ¡ˆ                                â”‚
â”‚     â””â”€ video_id: ä½¿ç”¨å·²å­˜åœ¨çš„ç‰‡æ®µï¼ˆè·³éä¸‹è¼‰å’Œåˆ‡å‰²ï¼‰              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  3. åˆ‡å‰²å½±ç‰‡ï¼ˆå¦‚æœæ²’æœ‰ video_idï¼‰                                â”‚
â”‚     - ä½¿ç”¨ _split_one_video()                                   â”‚
â”‚     - è¼¸å‡ºåˆ° segment/{stem}/segment_0000.mp4, ...              â”‚
â”‚     - è¨ˆç®— total_duration                                       â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  4. ä¸¦è¡Œè™•ç†æ‰€æœ‰ç‰‡æ®µ (ThreadPoolExecutor, max_workers=4)        â”‚
â”‚     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”‚
â”‚     â”‚  process_segment(seg_path, seg_idx)                   â”‚   â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚     â”‚  â”‚ 4.1 è¨ˆç®—æ™‚é–“ç¯„åœ                                  â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    - idx, start, end, time_range_str             â”‚ â”‚   â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚     â”‚                    â†“                                   â”‚   â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚     â”‚  â”‚ 4.2 VLM åˆ†æ (å¦‚æœ SKIP_VLM=False)             â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ analyze_segment_result(req_data)        â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚ 4.2.1 èª¿ç”¨ infer_segment_qwen()    â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   - å–æ¨£å½±æ ¼ (æ ¹æ“š sampling_fps)    â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   - è½‰æ›ç‚º Base64                    â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   - èª¿ç”¨ Ollama (qwen3-vl:8b)       â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   - è§£æ JSON å›æ‡‰                   â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚ 4.2.2 è³‡æ–™æ¸…æ´—èˆ‡æ¨™æº–åŒ–              â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   - frame_obj â†’ frame_norm          â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   - æå– events æ¬„ä½                â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   - è¨­ç½® defaults[k] = bool(v)      â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   âš ï¸ å•é¡Œé»ï¼šdefaults å¯èƒ½ç‚º None   â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚ 4.2.3 è¿”å›çµæœ                      â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   result = {                        â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚     "parsed": {                      â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚       "frame_analysis": frame_norm   â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚     }                                â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â”‚   }                                  â”‚ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â†“                                           â”‚   â”‚
â”‚     â”‚  â”‚  vlm_result = analyze_segment_result(...)     â”‚   â”‚
â”‚     â”‚  â”‚  âš ï¸ å•é¡Œé»ï¼šå¦‚æœç•°å¸¸ï¼Œvlm_result å¯èƒ½ç‚º None  â”‚   â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚     â”‚                    â†“                                   â”‚   â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚     â”‚  â”‚ 4.3 ç¢ºä¿ vlm_result æ˜¯æœ‰æ•ˆå­—å…¸                   â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    - æª¢æŸ¥ vlm_result is None or not dict         â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    - å¦‚æœç„¡æ•ˆï¼Œå‰µå»ºéŒ¯èª¤çµæœ                       â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    - ç¢ºä¿æœ‰ "parsed" å’Œ "raw_detection" æ¬„ä½      â”‚ â”‚   â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚     â”‚                    â†“                                   â”‚   â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚     â”‚  â”‚ 4.4 YOLO åµæ¸¬ï¼ˆå¿…é ˆåŸ·è¡Œï¼‰                        â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ 4.4.1 åˆå§‹åŒ– YOLO æ¨¡å‹ï¼ˆå¦‚æœæœªåˆå§‹åŒ–ï¼‰  â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚   - æª¢æŸ¥ _yolo_world_model              â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚   - å¦‚æœç‚º Noneï¼Œè¼‰å…¥æ¨¡å‹               â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ 4.4.2 åŸ·è¡Œ YOLO åµæ¸¬                    â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚   - ä½¿ç”¨ infer_segment_yolo_optimized()  â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚   - æˆ–å›é€€åˆ° infer_segment_yolo()        â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚ 4.4.3 åˆä½µ YOLO çµæœåˆ° vlm_result        â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚   vlm_result["raw_detection"]["yolo"] =   â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚     yolo_result                          â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚   âš ï¸ å•é¡Œé»ï¼šå¦‚æœ vlm_result ç‚º Noneï¼Œ   â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â”‚      é€™è£¡æœƒå‡ºéŒ¯                          â”‚ â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚ â”‚   â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚     â”‚                    â†“                                   â”‚   â”‚
â”‚     â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚   â”‚
â”‚     â”‚  â”‚ 4.5 è¿”å›çµæœ                                     â”‚ â”‚   â”‚
â”‚     â”‚  â”‚    return vlm_result                             â”‚ â”‚   â”‚
â”‚     â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚   â”‚
â”‚     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  5. æ”¶é›†æ‰€æœ‰ç‰‡æ®µçµæœ                                             â”‚
â”‚     - results = [result1, result2, ...]                         â”‚
â”‚     - æŒ‰ç´¢å¼•æ’åº                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  6. ä¿å­˜çµæœ                                                     â”‚
â”‚     â”œâ”€ 6.1 ä¿å­˜ JSON æª”æ¡ˆ                                        â”‚
â”‚     â”‚    - segment/{stem}/{stem}.json                          â”‚
â”‚     â”œâ”€ 6.2 è‡ªå‹•ç´¢å¼•åˆ° RAG (å¦‚æœ AUTO_RAG_INDEX=True)            â”‚
â”‚     â””â”€ 6.3 ä¿å­˜åˆ° PostgreSQL                                    â”‚
â”‚         - _save_results_to_postgres(db, results, stem)          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  7. è¿”å›æœ€çµ‚çµæœ                                                 â”‚
â”‚     {                                                            â”‚
â”‚       "model_type": "qwen",                                     â”‚
â”‚       "total_segments": N,                                      â”‚
â”‚       "success_segments": M,                                     â”‚
â”‚       "results": [...]                                          â”‚
â”‚     }                                                            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## å•é¡Œåˆ†æ

### ğŸ”´ å•é¡Œé» 1ï¼š`analyze_segment_result` ä¸­çš„è³‡æ–™æ¸…æ´—éšæ®µ

**ä½ç½®**ï¼š`video_analysis.py` ç¬¬ 131-180 è¡Œ

**å•é¡Œ**ï¼š
```python
defaults = frame_norm.get("events")  # å¦‚æœ frame_norm["events"] ç‚º Noneï¼Œdefaults å°±æ˜¯ None
defaults[k] = bool(v)  # âŒ éŒ¯èª¤ï¼š'NoneType' object does not support item assignment
```

**åŸå› **ï¼š
- `frame_norm["events"]` ç†è«–ä¸Šæ‡‰è©²æ˜¯å­—å…¸ï¼Œä½†åœ¨æŸäº›ç•°å¸¸æƒ…æ³ä¸‹å¯èƒ½è®Šæˆ None
- å¦‚æœ `frame_obj.get("events")` è¿”å› Noneï¼Œ`ev = frame_obj.get("events") or {}` æœƒè¨­ç½®ç‚º `{}`ï¼Œä½† `defaults` å¯èƒ½ä»ç„¶æ˜¯ None

**å·²ä¿®å¾©**ï¼š
- âœ… æ·»åŠ äº† `isinstance(defaults, dict)` æª¢æŸ¥
- âœ… å¦‚æœ `defaults` ä¸æ˜¯å­—å…¸ï¼Œé‡æ–°åˆå§‹åŒ–

### ğŸ”´ å•é¡Œé» 2ï¼š`vlm_result` å¯èƒ½ç‚º None

**ä½ç½®**ï¼š`video_analysis.py` ç¬¬ 552-600 è¡Œå’Œç¬¬ 815-870 è¡Œ

**å•é¡Œ**ï¼š
```python
vlm_result = analyze_segment_result(req_data)  # å¦‚æœç•°å¸¸ï¼Œå¯èƒ½è¿”å› None
# ...
vlm_result["raw_detection"] = {}  # âŒ éŒ¯èª¤ï¼šå¦‚æœ vlm_result ç‚º None
vlm_result["raw_detection"]["yolo"] = yolo_result  # âŒ éŒ¯èª¤
```

**åŸå› **ï¼š
- `analyze_segment_result` å¦‚æœå…§éƒ¨æ‹‹å‡ºæœªæ•ç²çš„ç•°å¸¸ï¼Œå¯èƒ½è¿”å› None
- æˆ–è€…è¿”å›çš„çµæœçµæ§‹ä¸å®Œæ•´ï¼ˆç¼ºå°‘ `parsed` æˆ– `raw_detection` æ¬„ä½ï¼‰

**å·²ä¿®å¾©**ï¼š
- âœ… åœ¨èª¿ç”¨ `analyze_segment_result` æ™‚æ·»åŠ  try-except
- âœ… ç¢ºä¿ `vlm_result` å§‹çµ‚æœ‰å®Œæ•´çš„çµæ§‹
- âœ… åœ¨è¨­ç½® YOLO çµæœå‰ï¼Œæª¢æŸ¥ `vlm_result` æ˜¯å¦ç‚ºæœ‰æ•ˆå­—å…¸

### ğŸ”´ å•é¡Œé» 3ï¼šçµæœçµæ§‹ä¸å®Œæ•´

**ä½ç½®**ï¼š`video_analysis.py` å¤šè™•

**å•é¡Œ**ï¼š
- éŒ¯èª¤çµæœä¸­ `parsed` å¯èƒ½æ˜¯ç©ºå­—å…¸ `{}`ï¼Œè€Œä¸æ˜¯å®Œæ•´çš„çµæ§‹
- `raw_detection` å¯èƒ½æ˜¯ `None`ï¼Œè€Œä¸æ˜¯ç©ºå­—å…¸ `{}`

**å·²ä¿®å¾©**ï¼š
- âœ… æ‰€æœ‰éŒ¯èª¤çµæœéƒ½åŒ…å«å®Œæ•´çš„ `parsed` çµæ§‹
- âœ… `raw_detection` å§‹çµ‚åˆå§‹åŒ–ç‚º `{}`

## ç•¶å‰æµç¨‹ç‹€æ…‹

### âœ… æ­£å¸¸æµç¨‹
1. å½±ç‰‡ä¸‹è¼‰/ç²å– âœ…
2. å½±ç‰‡åˆ‡å‰² âœ…
3. VLM åˆ†æï¼ˆQwen/Geminiï¼‰âœ…
4. YOLO åµæ¸¬ âœ…
5. çµæœåˆä½µ âœ…
6. ä¿å­˜åˆ° JSON å’Œ PostgreSQL âœ…

### âš ï¸ éœ€è¦æ³¨æ„çš„åœ°æ–¹
1. **VLM åˆ†æå¯èƒ½å¤±æ•—**ï¼šå¦‚æœ Ollama æœå‹™ä¸å¯ç”¨æˆ–æ¨¡å‹è¼‰å…¥å¤±æ•—
2. **YOLO æ¨¡å‹åˆå§‹åŒ–**ï¼šç¬¬ä¸€æ¬¡ä½¿ç”¨æ™‚éœ€è¦è¼‰å…¥æ¨¡å‹ï¼Œå¯èƒ½è¼ƒæ…¢
3. **ä¸¦è¡Œè™•ç†**ï¼šç›®å‰è¨­ç½®ç‚º 4 å€‹ä¸¦è¡Œï¼Œå¦‚æœ GPU è³‡æºä¸è¶³å¯èƒ½éœ€è¦èª¿æ•´

## å»ºè­°æ”¹é€²

1. **æ·»åŠ æ›´è©³ç´°çš„æ—¥èªŒ**ï¼šè¨˜éŒ„æ¯å€‹éšæ®µçš„åŸ·è¡Œæ™‚é–“å’Œç‹€æ…‹
2. **æ·»åŠ é‡è©¦æ©Ÿåˆ¶**ï¼šå°æ–¼ VLM åˆ†æå¤±æ•—çš„æƒ…æ³ï¼Œå¯ä»¥é‡è©¦
3. **å„ªåŒ–éŒ¯èª¤è™•ç†**ï¼šæä¾›æ›´æ¸…æ™°çš„éŒ¯èª¤è¨Šæ¯ï¼Œå¹«åŠ©èª¿è©¦
4. **ç›£æ§è³‡æºä½¿ç”¨**ï¼šç›£æ§ GPU å’Œå…§å­˜ä½¿ç”¨æƒ…æ³ï¼Œå‹•æ…‹èª¿æ•´ä¸¦è¡Œåº¦

