# PostgreSQL 資料庫結構說明

## 資料庫實體介面

### 資料庫名稱
- **資料庫名稱**: `postgres`
- **使用者**: `postgres`
- **密碼**: `postgres`
- **主機**: `postgres` (Docker 容器內) / `localhost` (外部連接)
- **埠號**: `5432`

---

## 資料表結構

### `summaries` 表

影片片段摘要資料表，儲存所有分析後的片段資訊。

#### 欄位說明

| 欄位名稱 | 類型 | 說明 | 約束 |
|---------|------|------|------|
| `id` | INTEGER | 主鍵，自動遞增 | PRIMARY KEY, AUTO INCREMENT |
| `start_timestamp` | DATETIME | 片段開始時間戳 | DEFAULT: 當前時間 |
| `end_timestamp` | DATETIME | 片段結束時間戳 | NULLABLE |
| `location` | VARCHAR(50) | 地點資訊 | NULLABLE |
| `camera` | VARCHAR(50) | 攝影機資訊 | NULLABLE |
| `message` | TEXT | 片段摘要文字（主要內容） | NULLABLE |
| `video` | VARCHAR(255) | 影片名稱（例如 "fire_1", "fire_2"） | NULLABLE |
| `segment` | VARCHAR(255) | 片段檔名（例如 "segment_0000.mp4"） | NULLABLE |
| `time_range` | VARCHAR(50) | 時間範圍字串（例如 "00:00:00 - 00:00:08"） | NULLABLE |
| `duration_sec` | FLOAT | 片段持續時間（秒） | NULLABLE |
| `time_sec` | FLOAT | 處理時間（秒） | NULLABLE |
| `water_flood` | BOOLEAN | 水災事件 | DEFAULT: FALSE |
| `fire` | BOOLEAN | 火災事件 | DEFAULT: FALSE |
| `abnormal_attire_face_cover_at_entry` | BOOLEAN | 異常著裝/遮臉入場 | DEFAULT: FALSE |
| `person_fallen_unmoving` | BOOLEAN | 人員倒地不起 | DEFAULT: FALSE |
| `double_parking_lane_block` | BOOLEAN | 併排停車/車道阻塞 | DEFAULT: FALSE |
| `smoking_outside_zone` | BOOLEAN | 非管制區吸菸 | DEFAULT: FALSE |
| `crowd_loitering` | BOOLEAN | 聚眾逗留 | DEFAULT: FALSE |
| `security_door_tamper` | BOOLEAN | 突破安全門 | DEFAULT: FALSE |
| `event_reason` | TEXT | 事件檢測原因說明 | NULLABLE |
| `created_at` | DATETIME | 建立時間 | DEFAULT: 當前時間, INDEXED |
| `updated_at` | DATETIME | 更新時間 | DEFAULT: 當前時間, AUTO UPDATE |

---

## 資料來源

### 目前資料來源
1. **JSON 檔案** (`segment/` 目錄)
   - 系統會從 JSON 檔案讀取分析結果
   - 透過 `migrate_segments_to_db.py` 可以將 JSON 遷移到資料庫

2. **即時分析**
   - 當影片片段分析完成後，會自動透過 `_save_results_to_postgres()` 保存到資料庫
   - 如果記錄已存在（相同 `video`, `segment`, `time_range`），則更新；否則新增

---

## 索引

### 自動建立的索引
- `id`: PRIMARY KEY（自動建立）
- `created_at`: INDEX（用於時間查詢優化）

### 建議的查詢欄位
- `start_timestamp`: 用於日期範圍查詢
- `video`, `segment`, `time_range`: 用於唯一性判斷和查詢

---

## 事件類型對應

| 中文名稱 | 資料庫欄位 | 說明 |
|---------|-----------|------|
| 水災 | `water_flood` | 積水、淹水等 |
| 火災 | `fire` | 火災、煙霧等 |
| 異常著裝/遮臉 | `abnormal_attire_face_cover_at_entry` | 遮臉入場 |
| 人員倒地 | `person_fallen_unmoving` | 倒地不起 |
| 併排停車 | `double_parking_lane_block` | 車道阻塞 |
| 非管制區吸菸 | `smoking_outside_zone` | 吸菸行為 |
| 聚眾逗留 | `crowd_loitering` | 群聚、逗留 |
| 突破安全門 | `security_door_tamper` | 闖入、突破 |

---

## 連接方式

### Docker 容器內連接
```python
DATABASE_URL = "postgresql://postgres:postgres@postgres:5432/postgres"
```

### 外部連接（從主機）
```python
DATABASE_URL = "postgresql://postgres:postgres@localhost:5432/postgres"
```

---

## 圖形化管理工具（pgAdmin）

### 訪問方式
1. **啟動服務**
   ```bash
   docker-compose up -d pgadmin
   ```

2. **打開瀏覽器**
   - 網址：`http://localhost:5050`
   - 帳號：`admin@admin.com`
   - 密碼：`admin`

3. **連接 PostgreSQL 伺服器**
   - 右鍵點擊 "Servers" → "Register" → "Server"
   - **General 標籤**：
     - Name: `PostgreSQL Server`（任意名稱）
   - **Connection 標籤**：
     - Host name/address: `postgres`（Docker 容器內）或 `localhost`（外部）
     - Port: `5432`
     - Maintenance database: `postgres`
     - Username: `postgres`
     - Password: `postgres`
     - 勾選 "Save password"
   - 點擊 "Save"

4. **查看資料庫**
   - 展開 "Servers" → "PostgreSQL Server" → "Databases" → "postgres" → "Schemas" → "public" → "Tables"
   - 可以看到 `summaries` 表
   - 右鍵點擊表名 → "View/Edit Data" → "All Rows" 查看資料

---

## 初始化步驟

1. **啟動 PostgreSQL 服務**
   ```bash
   docker-compose up -d postgres
   ```

2. **執行初始化腳本**（一次性）
   ```bash
   docker exec test_platform-main-backend-1 python3 /app/src/init_db.py
   ```

3. **刪除初始化腳本**
   ```bash
   rm backend/src/init_db.py
   ```

---

## 查詢範例

### 查詢特定日期的記錄
```sql
SELECT * FROM summaries 
WHERE start_timestamp >= '2025-12-19 00:00:00' 
  AND start_timestamp < '2025-12-20 00:00:00';
```

### 查詢火災事件
```sql
SELECT * FROM summaries WHERE fire = TRUE;
```

### 查詢包含關鍵字的摘要
```sql
SELECT * FROM summaries 
WHERE message ILIKE '%藍色衣服%';
```

### 查詢特定影片的片段
```sql
SELECT * FROM summaries 
WHERE video = 'fire_1' 
ORDER BY start_timestamp;
```

