services:
  # RTSP Server - 串流伺服器中心
  rtsp-server:
    image: bluenviron/mediamtx:latest
    restart: unless-stopped
    ports:
      - "8554:8554"   # RTSP 埠
      - "8888:8888"   # HLS 埠 (可選用)
      - "8889:8889"   # WebRTC 埠 (可選用)
    networks:
      - app-network

  # Stream Simulator - 模擬攝影機推流
  stream-simulator:
    image: linuxserver/ffmpeg:latest
    container_name: stream-simulator
    restart: unless-stopped
    depends_on:
      - rtsp-server
    volumes:
      - ../video:/videos:ro  # 掛載實體影片路徑
    networks:
      - app-network
    # 循環推流指令：使用 -stream_loop -1 達到無限循環
    # 使用 -re 確保以真實影片速率推流，避免時間戳混亂與檔案過大
    command: >
      -re -stream_loop -1 
      -i "/videos/門禁遮臉入場/Video_衛哨端出入口2.avi" 
      -c copy 
      -f rtsp 
      rtsp://rtsp-server:8554/live

  # Ollama Service
  ollama:
    image: ollama/ollama:latest
    restart: unless-stopped
    ports:
      - "11434:11434"
    volumes:
      - ollama_data:/root/.ollama
    networks:
      - app-network
    extra_hosts:
      - "registry.ollama.ai:104.16.55.3"
      - "registry.ollama.ai:104.16.54.3"
    deploy:
      resources:
        reservations:
          devices:
            - driver: nvidia
              count: all
              capabilities: [gpu]

  # PostgreSQL Database
  postgres:
    image: pgvector/pgvector:pg15
    restart: unless-stopped
    environment:
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
    volumes:
      - postgres_data:/var/lib/postgresql/data
    ports:
      - "5432:5432"
    networks:
      - app-network
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U postgres"]
      interval: 10s
      timeout: 5s
      retries: 5

  # pgAdmin
  pgadmin:
    image: dpage/pgadmin4:latest
    restart: unless-stopped
    environment:
      - PGADMIN_DEFAULT_EMAIL=admin@admin.com
      - PGADMIN_DEFAULT_PASSWORD=admin
      - PGADMIN_CONFIG_SERVER_MODE=False
      - PGADMIN_CONFIG_MASTER_PASSWORD_REQUIRED=False
    volumes:
      - pgadmin_data:/var/lib/pgadmin
    ports:
      - "5050:80"
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy

  # Backend API
  backend:
    build:
      context: ./backend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - PROJECT_ROOT=${PROJECT_ROOT}
      - HOST=${HOST}
      - PORT=8080
      - RELOAD=${RELOAD}
      - WORKERS=${WORKERS}
      - LOG_LEVEL=${LOG_LEVEL}
      - ADMIN_TOKEN=${ADMIN_TOKEN}
      - SESSION_TTL_SEC=${SESSION_TTL_SEC}
      - AUTO_RAG_INDEX=true
      - RAG_DIR=./rag_store
      - RAG_STORE_DIR=./rag_store
      - OLLAMA_EMBED_MODEL=bge-m3
      - OLLAMA_BASE=http://ollama:11434
      - GEMINI_API_KEY=${GEMINI_API_KEY}
      - MY_API_KEY=${MY_API_KEY}
      - POSTGRES_USER=postgres
      - POSTGRES_PASSWORD=postgres
      - POSTGRES_DB=postgres
      - POSTGRES_HOST=postgres
      - POSTGRES_PORT=5432
    volumes:
      - ./backend/src:/app/src:delegated
      - ./backend/segment:/app/segment
      - ./backend/rag_store:/app/rag_store
      - ./backend/prompts:/app/prompts
      - ../video:/app/video:ro
      - ~/.cache/huggingface:/root/.cache/huggingface:ro
    networks:
      - app-network
    depends_on:
      postgres:
        condition: service_healthy
      ollama:
        condition: service_started
      rtsp-server: # 確保 backend 知道 rtsp-server 存在
        condition: service_started
  # Frontend
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile
    restart: unless-stopped
    environment:
      - WDS_SOCKET_HOST=localhost
      - WDS_SOCKET_PORT=3000
    volumes:
      - ./frontend:/app:delegated
      - node_modules_data:/app/node_modules
    networks:
      - app-network
    depends_on:
      - backend

  # Nginx Reverse Proxy
  nginx:
    image: nginx:alpine
    restart: unless-stopped
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
    ports:
      - "3000:80"
    networks:
      - app-network
    depends_on:
      - backend
      - frontend

networks:
  app-network:
    driver: bridge

volumes:
  node_modules_data:
  ollama_data:
  postgres_data:
  pgadmin_data:
